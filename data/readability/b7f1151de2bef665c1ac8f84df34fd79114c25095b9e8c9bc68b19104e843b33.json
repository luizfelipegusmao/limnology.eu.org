{"title":"Building my own router and HomeKit hub","link":"https://www.llun.me/posts/dev/2017-06-04-building-my-own-router-and-homekit-hub/","date":1496534400000,"content":"<div id=\"readability-page-1\" class=\"page\"><div><p>It starts with one Wifi speaker I bought last year which has HTTP server and API allow to control it programmatically. To make it connect with HomeKit at that time, I use <a href=\"https://github.com/nfarina/homebridge\" target=\"_blank\" rel=\"noopener\">HomeBridge</a> with <a href=\"https://github.com/CONNCTED/homebridge-soundtouch\" target=\"_blank\" rel=\"noopener\">SoundTouch plugin</a>. The setup is very simple. Only one limitation, it doesn't allow to control preset. So I create my plugin and add more and more devices to the HomeKit, to the point I want everything to automate when I leave or join wifi which most router doesn't support yet.</p><h2 id=\"first-version\">First version <a href=\"#first-version\">#</a></h2><p>I start with Intel NUC and wifi dongle that can find easily on the market. I already use my NUC as a router for a long time to connect from my room wifi router to the primary wifi router which owns by the landlord. This way I can isolate all my devices from other who also renting the same house.<br>Dongle I use in the first version is <a href=\"https://wikidevi.com/wiki/ASUS_USB-AC56\" target=\"_blank\" rel=\"noopener\">ASUS AC-56</a>, the chipset inside is <a href=\"https://github.com/diederikdehaas/rtl8812AU\" target=\"_blank\" rel=\"noopener\">Realtek RTL8812AU</a> which can find in the Github however it is not official support from the Realtek itself. To make its work as Wifi station have to compile from the source with version 4.3.22 beta. The performance is not bad but not reliable. I have to reset every week sometime.</p><p>I change it to <a href=\"http://www.tp-link.sg/products/details/cat-11_Archer-T9UH.html\">TP-Link Archer T9UH</a> (<a href=\"https://github.com/llun/rtl8814AU\" target=\"_blank\" rel=\"noopener\">rtl8814AU</a>) in the hope that it will be faster and more stable. However, the performance is not improved at all, so I start looking for router board.</p><h2 id=\"second-version%2C-hardware\">Second version,&nbsp;hardware <a href=\"#second-version%2C-hardware\">#</a></h2><p>Because my requirement is this router have to be able to connect to the primary router via Wifi, so I need at least three wifi cards for each spectrum, two for 5 GHz and one for 2.4 GHz.</p><p>Most of the router boards in the market supports only two wifi cards, only these few brands I found so far that supports three</p><ul><li><a href=\"http://www.compex.com.sg/product/wpq864/\">Compex WPQ864</a> This is the one I use because I found first and they also has wifi cards selling together.</li><li><a href=\"https://www.solid-run.com/marvell-armada-family/clearfog/\" target=\"_blank\" rel=\"noopener\">ClearFog Pro</a> has only two PCI Express, but it has an M2 port which some wifi cards are using it.</li><li><a href=\"https://estore.alagasnetwork.sg/mikrotik/routerboard.html\" target=\"_blank\" rel=\"noopener\">Router Board</a> I found this quite late after got the Compex board. It has more option and has OS from Mikrotik which can replace with OpenWRT.</li></ul><p>All my wifi cards are from Compex and have from 2 MIMO card to 4 MIMO. I use the old AC Wave 1 card with <a href=\"http://www.compex.com.sg/product/wle600vx/\">three streams MIMO</a>, but this can upgrade later when newer Wifi standard come out.<br>WPQ864 router in the foam&nbsp;boxOne benefit of building my router is I can choose an internal antenna. Compare to the market router that mostly uses external spider style antenna. I found only two company so far that is selling MIMO antenna in Mouser, <a href=\"http://www.mouser.sg/ProductDetail/Taoglas/FXP523A07A001/?qs=sGAEpiMZZMu6TJb8E8Cjr7j%252bpfwlA7T%2fPxI0W26r0Bs%3d\">Touglas</a> and <a href=\"http://www.mouser.sg/ProductDetail/Pulse/W6103B0100/?qs=sGAEpiMZZMuYaq4aOfOV%252bH4NNrKPTwjdKV995Qplx2A%3d\">Pulse</a> but Compex itself also selling but in the another board format for 4x4 MIMO.<br>My configuration is Compex864 + 3 wle600vx and 3 Taoglas Antenna.</p><h3 id=\"build-%26-flash-firmware\">Build &amp; flash&nbsp;firmware <a href=\"#build-%26-flash-firmware\">#</a></h3><p>Default firmware from Compex is <a href=\"http://downloads.compex.com.sg/?dir=uploads/QSDK/WPQ864/1GB-RAM\">QSDK</a> which base on old OpenWRT version and many packages are not in the branch. To install package mostly will have to compile on board again.</p><p>I switch to LEDE for more modern kernel (4.9) and however default AP148 configuration is supported only 2 PCIE cards cause my third Wifi card is not working, to enable it, I create a new DTS definition, and this might add in the future <a href=\"https://github.com/llun/lede\" target=\"_blank\" rel=\"noopener\">LEDE/OpenWRT</a></p><p>To build the firmware, follow the <a href=\"https://lede-project.org/docs/guide-developer/quickstart-build-images\" target=\"_blank\" rel=\"noopener\">quick build guide</a> and choose the legacy version which will produce the artifact in the target directory.</p><p>Later follow the process base from Compex document in <a href=\"http://downloads.compex.com.sg/?dir=uploads/QSDK/WPQ864/1GB-RAM/ipq806x-spf30-r030/b161206\">readme here</a> and support I got via the conversation in email.</p><ul><li>Prepare TFTP server, for OSX, follow <a href=\"https://rick.cogley.info/post/run-a-tftp-server-on-mac-osx/\" target=\"_blank\" rel=\"noopener\">this guide</a></li><li>Move the artifact's file into the TFTP server directory</li><li>Set TFTP server IP address to <code>192.168.10.1</code> (This can change to any IP)</li><li>Connect to the router via console port<br>Reboot the router and enter to u-boot console by pressing any key before it start to boot the OS</li><li>Set router IP <code>set ipaddr 192.168.10.20</code> (It can be other IP but has to be the same group with TFTP server)</li><li>Set target TFTP server IP <code>set serverip 192.168.10.1</code> (This is the same IP as above)</li><li>Set ethaddr to the MAC Address of the router ethernet port <code>set ethaddr 00:aa:bb:cc:dd:ee</code></li><li>Set boot arguments <code>set bootargs console=ttyMSM0,115200n8</code> and save <code>saveenv</code></li><li>Test the board can connect to the server with ping command <code>ping \\${serverip}</code></li><li>Load firmware to router <code>tftpboot 0x42000000 lede-ipq806x-WPQ864-legacy-squashfs-nand-factory.ubi (Filename can be different)</code></li><li>Flash the router</li></ul><pre><code>ipq_nand linux\nnand erase 0x1340000 0x4000000\nnand write 0x42000000 0x1340000 \\$filesize\nBoot the router\n</code></pre><p>After this adding Avahi package to the router, this will use later by HC for announcing devices that will use by HomeKit. Other than that is Luci for network management UI. It is optional and plans to remove it and build myself for more simple UI with Home automation control inside.</p><h3 id=\"homekit-hub-for-router\">HomeKit hub for&nbsp;Router <a href=\"#homekit-hub-for-router\">#</a></h3><p>The most popular open source for HomeKit is <a href=\"https://github.com/nfarina/homebridge\" target=\"_blank\" rel=\"noopener\">HomeBridge</a>, but I have trouble running node.js on the board. The alternative way is building it with <a href=\"https://github.com/brutella/hc\" target=\"_blank\" rel=\"noopener\">Golang</a></p><p>The framework is solid, stable except the MDNS part which I have to change it and depend <a href=\"https://github.com/llun/hc\" target=\"_blank\" rel=\"noopener\">on Avahi instead</a></p><p>HC itself is not the same as HomeBridge. It is comparable to <a href=\"https://github.com/KhaosT/HAP-NodeJS\" target=\"_blank\" rel=\"noopener\">Node-HAP</a> which provide the framework for talking to HomeKit, including HomeKit protocol encryption, HTTP server and MDNS service for other devices to pull information and sending a command to it.</p><p>HC can use with one single device and start it with a different port, but there is device type call hub that can use to group all device to single HC and this is what HomeBridge does.</p><p>When starts the HC/Node-HAP, it will start HTTP Server and register itself to MDNS service announce to every device that joins the HomeKit that information and control are available in this port at this address. And when HomeKit app is open on iPhone or sensor is detected something it will send information to iPad or Apple TV. Depending on what is your set as a HomeKit hub and its will check does it need to do something as automation, if it needs, it will look into MDNS for devices it needs to send a command to and encrypt the command and send to those devices via Bluetooth or Wifi network.</p><p>I start to replicate device from Node.js plugin to Golang for HC, and so far I have three devices, SoundTouch, Wifi router, and Sensibo.</p><h3 id=\"soundtouch\"><a href=\"https://github.com/llun/hksoundtouch\" target=\"_blank\" rel=\"noopener\">SoundTouch</a> <a href=\"#soundtouch\">#</a></h3><p><a href=\"https://www.bose.com/en_us/products/speakers/wireless_speakers.html#multistory=group-1-panel-1\" target=\"_blank\" rel=\"noopener\">SoundTouch</a> is a speaker from Bose. I choose this one because already have another Bose speaker before but I didn't expect that it has API to control. At the time, I was just looking for Wifi speaker that has standard audio input so that I can connect it to the monitor and control it with the phone.</p><p>SoundTouch is the easiest for creating a plugin. It has WebSocket, and HTTP API cover most of the functionality. I don't have an official document <a href=\"http://products.bose.com/api-developer/index.html\">which requires sending an email to contact them</a>. However, (old) API document <a href=\"https://www.google.com.sg/search?q=Bose+soundtouch+api&amp;oq=Bose+soundtouch+api&amp;aqs=chrome..69i57j69i60j0j69i60l2.3803j0j7&amp;sourceid=chrome&amp;ie=UTF-8\" target=\"_blank\" rel=\"noopener\">can google for it</a> and seems still valid.</p><p>HomeBridge plugin before convert to Golang <a href=\"https://github.com/llun/homebridge-soundtouch\" target=\"_blank\" rel=\"noopener\">code is here</a> which I already add presets functions, so in the morning I can rotate music theme from Spotify base on the day and here is <a href=\"https://github.com/llun/soundtouch-golang\" target=\"_blank\" rel=\"noopener\">Go version for HC.</a></p><p>HC version is using Speaker accessory type. So it cannot control directly from the HomeKit application. I guess this will enable when Apple release it own speaker. Controlling speaker still possible by using the third party (I use Eve) also automation has to set in third party application too.</p><h3 id=\"sensibo\"><a href=\"https://github.com/llun/hksensibo\" target=\"_blank\" rel=\"noopener\">Sensibo</a> <a href=\"#sensibo\">#</a></h3><p><a href=\"https://sensibo.com/\" target=\"_blank\" rel=\"noopener\">Sensibo</a> is infrared air conditioning controller and Weather sensor. It's a cheapest so far (excluding the universal infrared like Broadlink RM) I found. An alternative is <a href=\"https://www.tado.com/\" target=\"_blank\" rel=\"noopener\">Tado</a>, <a href=\"http://www.airpatrol.eu/shop/airpatrol-wifi/\">Air Patrol</a> and <a href=\"https://www.kickstarter.com/projects/ambi-labs/ambi-climate-2-ai-enhanced-air-conditioning-comfor\" target=\"_blank\" rel=\"noopener\">Ambi Climate</a> which version two is the same price as Sensibo now.</p><p>Few things I don't like, Sensibo is cloud base and have to send a command to online service only. If the internet is down, it's useless. Also, it does not have a battery, have to connect to the nearby USB station all the time ( an alternative is to connect it to the power bank and hang it on the wall, but it looks weird.) Maybe they might come up with the battery again similar to the first version with the same price and allow to control it locally like SoundTouch without going to the internet all the time.</p><p>HomeBridge plugin version can <a href=\"https://github.com/pdlove/homebridge-sensibo\" target=\"_blank\" rel=\"noopener\">found it here</a> (and also <a href=\"https://github.com/llun/homebridge-sensibo\" target=\"_blank\" rel=\"noopener\">mine fork version</a> which just convert it to ES6 in the hope it might be easier to work with.) The major issue that I found in the plugin is, Sensibo does not support applying multiple properties at the same time even thought <a href=\"http://static.sensibo.com/SensiboAPI_v2.yaml\">the API</a> allow to do it. This issue seems to cause the device state confusing, and sometimes it turns on/off air conditioning device randomly.</p><figure><img src=\"https://www.llun.me/posts/dev/2017-06-04-building-my-own-router-and-homekit-hub/homekit.jpg\" alt=\"\"><figcaption>HomeKit and HomeBridge Sensibo</figcaption></figure><p>So in <a href=\"https://github.com/llun/hksensibo\" target=\"_blank\" rel=\"noopener\">Golang version</a>, all the command are put into the queue and send out every one second. Also, for the temperature adjustment, it will override the previous before sending out if you send multiple times (This happen because on iPhone when adjusting the temperature and release the single, it send two temperature values for two touch events, move and touch end)</p><h3 id=\"wifi-occupancy\"><a href=\"https://github.com/llun/hkwifioccupancy\" target=\"_blank\" rel=\"noopener\">Wifi Occupancy</a> <a href=\"#wifi-occupancy\">#</a></h3><p>In the beginning, I start with DHCP table to detect which devices are in the network. This method does not work because the TTL of record is too long to tell the device is leaving. An alternative way I found out is using iw polling wifi card status and write it to the file. HC will keep reading this file by listening to the file changes.</p><p>It is working well except some time the polling produce an empty file cause the HomeKit trigger that I'm leaving the room and turn off everything. Adjusting the timing by adding a delay before reading file seems help but still cause wrong trigger time to time.</p><p>The last method is listening to the devices change directly. The easiest way is pipe all the information from the iw to the process directly which probably work, but I didn't try this method. Another way is listening on Netlink. <a href=\"https://medium.com/@mdlayher/linux-netlink-and-go-part-1-netlink-4781aaeeaca8\" target=\"_blank\" rel=\"noopener\">This article</a> is giving very detail what is the Netlink and how does Netlink work and I also use his library to build this detection.</p><p>Listening to Netlink for device changes, I start by <a href=\"https://github.com/llun/hkwifioccupancy/blob/master/netlink_presence.go#L44-L49\" target=\"_blank\" rel=\"noopener\">joining</a> <a href=\"https://github.com/llun/hkwifioccupancy/blob/master/netlink_presence.go#L44-L49\" target=\"_blank\" rel=\"noopener\"><code>mlme</code></a> <a href=\"https://github.com/llun/hkwifioccupancy/blob/master/netlink_presence.go#L44-L49\" target=\"_blank\" rel=\"noopener\">multicast group</a> which produce all message from the physical layer. It might not be the same for old Kernel version which these type of messages provides from <a href=\"https://github.com/mdlayher/netlink/blob/master/example_test.go#L63-L71\" target=\"_blank\" rel=\"noopener\"><code>rtmp</code></a> <a href=\"https://github.com/mdlayher/netlink/blob/master/example_test.go#L63-L71\" target=\"_blank\" rel=\"noopener\">channel</a>. My Kernel target is 4.9, so to use this will need to check the version of OpenWRT first.</p><p>The message comes out from <code>mlme</code> channel consists of MAC address and other information, but in this case, MAC address is enough. At the beginning of the HC process, it will get input what devices I want to use for detecting. I am in the room or not, the plugin will intersect the devices list from Netlink message and my MAC address list, when the list has any item it will trigger that I am in the room/home. Otherwise, I am outside.</p><h3 id=\"bridge\"><a href=\"https://github.com/llun/hkbridge\" target=\"_blank\" rel=\"noopener\">Bridge</a> <a href=\"#bridge\">#</a></h3><p>Last piece for putting all plugins together. This part is the same as building HomeBridge. Bridge itself is an empty accessory that contains all other devices and makes it as a child. I link other accessories by <a href=\"https://github.com/llun/hkbridge/blob/master/accessories.go#L10-L12\" target=\"_blank\" rel=\"noopener\">hard coding in the import part</a>, this might be able to change later when I can compile the accessory to the library and load it at runtime.</p><h3 id=\"putting-everything-together\">Putting everything together <a href=\"#putting-everything-together\">#</a></h3><p>So at this point, I have</p><ul><li>✅ Router, firmware and base packages (Avahi)</li><li>✅ All devices HC plugins</li><li>✅ HC Bridge device</li></ul><p>Running make inside the hub will produce Compex WPQ864 binary which is ARM5 (WPQ864 itself is ARM7A, but Golang doesn't support VFPv4 yet, so have to fall back to old ARM5)</p><p>Uploading binary to the router, adding configuration</p><pre><code>{\n  \"name\": \"MyBridge\",\n  \"manufacturer\": \"Your own manufacturer\",\n  \"serial\": \"Magic Serial Number\",\n  \"model\": \"Super Awesome HomeControl bridge\",\n  \"pin\": \"12345678\",\n  \"port\": \"51826\",\n  \"debug\": true,\n  \"accessories\": [\n    {\n      \"type\": \"github.com/llun/hksoundtouch\"\n    },\n    {\n      \"type\": \"github.com/llun/hkwifioccupancy\",\n      \"option\": {\n        \"file\": \"/tmp/presence.wifi\",\n        \"addresses\": [\n          \"mac address\"\n        ]\n      }\n    },\n    {\n      \"type\": \"github.com/llun/hksensibo\",\n      \"option\": {\n        \"key\": \"sensibo-api-key\"\n      }\n    }\n  ]\n}\n</code></pre><p>Setup HomeKit by adding accessory in the iPhone, adding automation and done.</p><figure><img src=\"https://www.llun.me/posts/dev/2017-06-04-building-my-own-router-and-homekit-hub/homekit_active.jpg\" alt=\"\"><figcaption>Final accessories in my&nbsp;HomeKit</figcaption></figure><h3 id=\"after-this%2C-what-else\">After this, what&nbsp;else <a href=\"#after-this%2C-what-else\">#</a></h3><p>Now, I start my day with Spotify music I set on the preset which automate toggle on in the morning by HomeKit. The air conditioning is turning off. I take a shower and leaving the room. Music is turning off.</p><p>Coming back home in the evening when my phone is joining wifi when walking passing outside the window, the light turns itself on, air conditioning set to temperature I like. Spotify starts playing again on the different channel.</p><p>This already good, but I still want more things to automate. The window can open itself on and off. The door lock and unlock itself when I reach home and would be better if I'm right in front of the door open it for me. The washing machine can tell me when it will finish and what time I need to take the cloth out to the dryer. More than that would be a robot that keeps my room clean which is probably the last thing I can get in far future.</p><p>But now, I need to build a box for my router first.</p></div></div>","author":"","siteTitle":"@llun story","siteHash":"e492a4c5a091b6624e5872d8d003bc73eb1166cc8f88db58c44e1f8dfb9c7252","entryHash":"b7f1151de2bef665c1ac8f84df34fd79114c25095b9e8c9bc68b19104e843b33","category":"Me"}