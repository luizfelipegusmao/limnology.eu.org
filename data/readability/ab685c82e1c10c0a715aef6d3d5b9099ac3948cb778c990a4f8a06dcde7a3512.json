{"title":"Next-level visualizations with ExploreTrees.SG","link":"https://cheeaun.com/blog/2019/07/next-level-visualizations-exploretrees-sg/","date":1562716800000,"content":"<div id=\"readability-page-1\" class=\"page\"><div itemprop=\"articleBody\"><p>Last year, I <a href=\"https://cheeaun.com/blog/2018/04/building-exploretrees-sg/\">wrote about one of my most ambitious side project ever</a>, <a href=\"https://exploretrees.sg/\">ExploreTrees.SG</a>. It was simply <strong>breath-taking</strong>.</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/tree-families-legend-layers-panel-exploretrees-sg@2x.png\" alt=\"Tree families legend on layers panel, on ExploreTrees.SG\" width=\"1024\" height=\"768\" loading=\"lazy\"></figure><h2>Revisiting the masterpiece</h2><p>I havenâ€™t touch it since then. March this year, I <em>suddenly</em> had an itch to update the dataset and see if anythingâ€™s changed. I ran the script to fetch the latest data and <a href=\"https://twitter.com/cheeaun/status/1108010887984472069\">got this</a>:</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/software/terminal-script-generating-trees-data@2x.jpg\" alt=\"Terminal showing a script generating trees data\" width=\"471\" height=\"277\" loading=\"lazy\"></figure><p>Itâ€™s a script that scrapes data from <a href=\"https://www.nparks.gov.sg/\">National Parks Board</a>â€™s <a href=\"http://trees.sg/\">Trees.sg</a>, showing the total count of trees and species, and generates a GeoJSON file. From the count, I can compare the previous yearâ€™s number of trees to this yearâ€™s.</p><p>March last year, <strong>564,266</strong> trees. March this year, <strong>564,678</strong> trees. It increased by few hundreds!</p><p>Looking back previously, I attempted to render <strong>all</strong> trees on the map <em>in</em> the web browser, but failed due to exceedingly large file size and slow performance. I ended up uploading the data to <a href=\"https://www.mapbox.com/mapbox-studio/\">Mapbox Studio</a> as <a href=\"https://docs.mapbox.com/help/glossary/vector-tiles/\">vector tileset</a>, to be served back on the map. Itâ€™s not a pure client-side solution, but a back-end supported one, which makes it no different from Trees.sg <em>except</em> itâ€™s faster ğŸ¤·â€â™‚ï¸.</p><p>Ultimately, I still want to achieve this pure client-side solution because I <em>love</em> to push the limits ğŸ˜‰.</p><p>A year has passed, technologies have improved, right?</p><p>I took a hard look at <code>trees-everything.geojson</code> which contains <em>all</em> trees data. Itâ€™s <strong>197.6 MB</strong> in size, which is <em>insane</em> for any web sites.</p><p>I came up with two ideas:</p><ol><li>Give up on the GeoJSON format. Embrace normal JSON, remove all the keys and only store values. Convert, for example <code>{\"id\": \"123\", \"height\": 200}</code> into <code>[\"123\", 200]</code>. Keys will be hardcoded somewhere else in the code.</li><li>Group <em>all</em> coordinates of trees into an array, technically like a line, and convert into <a href=\"https://developers.google.com/maps/documentation/utilities/polylinealgorithm\">Encoded Polyline Algorithm Format</a>. Itâ€™s a lossy compression algorithm that allows you to store a series of coordinates as a single string. Itâ€™s lossy, with a precision of 5 decimal places, roughly <a href=\"https://en.wikipedia.org/wiki/Decimal_degrees#Precision\">1 m in distance near equator</a>. For example, <code>[[1.27612,103.84744], [1.28333,103.85945]]</code> will be encoded into a shorter string: <code>wfxFouyxRal@ajA</code>.</li></ol><p>Hereâ€™s the code:</p><pre><code>const data = JSON.parse(fs.readFileSync('data/trees-everything.geojson'));\n\nconst props = data.features.map(f =&gt; Object.values(f.properties).map(v =&gt; v === null ? '' : v));\n\nconst points = data.features.map(f =&gt; f.geometry.coordinates);\nconst line = polyline.encode(points);\n\nconst finalData = { props, line };\n</code></pre><p>One is the <code>props</code> variable storing all the values and one more <code>line</code> variable for the encoded polyline string.</p><p>The final result is a <strong>37.7 MB</strong> JSON file. Thatâ€™s <strong>524% smaller</strong> than the GeoJSON file! ğŸ˜± After I compress the file with <a href=\"https://en.wikipedia.org/wiki/Gzip\">gzip</a>, it becomes <a href=\"https://twitter.com/cheeaun/status/1108020569251827712\"><strong>5.7 MB</strong></a>, <strong>3,466% smaller</strong>! ğŸ˜±ğŸ˜±</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/software/finder-trees-data-files@2x.jpg\" alt=\"macOS Finder window showing trees data files, in GeoJSON, JSON and Gzip formats\" width=\"651\" height=\"115\" loading=\"lazy\"></figure><p>I think 5.7 MB is not bad. According to this <a href=\"https://speedcurve.com/blog/web-performance-page-bloat/\">2017 article on SpeedCurve</a>, the average web page size was 3 MB and it predicted that by 2019, it will be 4 MB.</p><blockquote><p>According to the HTTP Archive, <strong>almost 16% of pages today â€“ in other words, about 1 out of 6 pages â€“ are 4 MB or greater in size</strong>.</p></blockquote><p>That â€œtodayâ€ was in 2017.</p><p>Compared to those sites that load 4 MB of <em>junk</em> plus few bytes of real content, Iâ€™m building an <em>awesome</em> site with 5 MB of useful data plus few hundred kilobytes of map tiles and JavaScript files.</p><p>Obviously at this point, Iâ€™m trying really hard to justify my actions ğŸ˜…. Iâ€™m very excited that I manage to squeeze the bytes out of the dataset, but itâ€™s still not small enough to be <em>lower</em> than the average web page size, so I try to deceive myself that I can do this for a good reason ğŸ˜‚.</p><p>As I look at the dataset, I noticed a few changes. I investigated and found that:</p><ul><li>Some flowering trees are gone, which I have no idea what happened until now.</li><li>The API URL has changed from <code>https://imaven.nparks.gov.sg/arcgis/rest/services/maven/PTMap/FeatureServer/2/query</code> to <code>https://imaven.nparks.gov.sg/arcgis/rest/services/maven/Hashing_UAT/FeatureServer/0/query</code>.</li></ul><p>The returned response has changed too. The most significant one is the <strong>tree girth</strong> data. It used to be precise measurements like 1.1 meters, but it became ranges like <code>0.0 - 0.5</code> and <code>&gt; 1.5</code>. I donâ€™t know the exact reason but I guess tree girths are pretty complicated stuff.</p><p>While re-fetching the data from scratch, I decided to restructure the grids. The fetching works by constructing a list of grids that will be passed as boundaries for the API calls. In other words, every box is equivalent to one API request. The previous one looks like this:</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/square-grid-singapore-boundary.png\" alt=\"Square grids around Singapore boundary\" width=\"1000\" height=\"675\" loading=\"lazy\"></figure><p>60 boxes, 60 API requests. The right and bottom side are sort of <em>neglected</em>, and luckily there are no trees data in those areas.</p><p>The new grid looks like this:</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/new-square-grid-singapore-boundary@2x.jpg\" alt=\"The new square grids around Singapore boundary\" width=\"775\" height=\"468\" loading=\"lazy\"></figure><p>630 boxes, 630 API requests. Higher coverage over the whole Singapore <em>but</em> not the further southern parts. Fortunately, most trees are covered, as in the trees in other areas are not recorded by National Parks <em>yet</em>.</p><p>So, I got <strong>all</strong> the new data. I plotted them on the map with <a href=\"https://deck.gl/#/\">Deck.gl</a>, a large-scale WebGL-powered data visualization library by Uber. It has better performance when it comes to large quantities of map features as Iâ€™ve tried in <a href=\"https://cheeaun.com/blog/2019/02/building-busrouter-sg/\">my previous side project</a>.</p><p>It wasâ€¦ <strong>slow</strong>. ğŸ˜°</p><p>Nope, itâ€™s not the fault of the library or Mapbox. Itâ€™s Chrome. My Chrome desktop browser was taking a <em>long</em> time decoding the JSON response. Turns out JSON parsing is pretty darn slow for super large files. Itâ€™s also a synchronous blocking operation. It took <strong>more than 10 seconds</strong> on my Macbook Air (2019). ğŸ˜°</p><p>As I start to switch from my home-grown build scripts to <a href=\"https://parceljs.org/\">Parcel</a>, even the Parcel build step fails with â€œAllocation failed - JavaScript heap out of memoryâ€ errors. I guess it tries to read the JSON file, probably doing something to it and Node keeps running out of memory ğŸ˜…. I <em>could</em> fix the build step but letâ€™s not get sidetracked here.</p><p>Maybe I need a faster <code>JSON.parse</code>. Maybe I could run it in a <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers\">web worker</a>, but it could be even slower due to the huge payload in message passing.</p><p>I had a different idea in mind, that is to use a <em>different</em> data format. Mapbox uses <a href=\"https://developers.google.com/protocol-buffers/\">Protocol buffers</a> for the map tiles. Deck.gl supports <a href=\"https://deck.gl/#/documentation/developer-guide/performance-optimization?section=on-using-binary-data\">some form of binary data</a> with an upcoming <a href=\"https://github.com/uber/deck.gl/blob/master/dev-docs/RFCs/v7.x-binary/binary-data-rfc.md\">RFC</a>, which looksâ€¦ quite complicated for me.</p><p>I ended up using <a href=\"https://msgpack.org/\">MessagePack</a> because:</p><ol><li>Protocol buffers need types (<code>double</code>, <code>int64</code>, etc) and itâ€™s quite troublesome to do a quick conversion from JSON. Iâ€™ve tried converting the GeoJSON file using <a href=\"https://github.com/mapbox/geobuf\"><code>Geobuf</code></a> and the file size still seems bigger than MessagePackâ€™s (with my combo compression ideas mentioned above).</li><li>Deck.glâ€™s binary data thing doesnâ€™t seem to be stable <em>yet</em> and needs manual manipulation on the data.</li><li>MessagePack just worksâ„¢.</li></ol><p>There are two libraries available that can perform encoding and decoding of the MessagePack format:</p><ul><li><a href=\"https://www.npmjs.com/package/msgpack-lite\">msgpack-lite</a> (listed on the official site)</li><li><a href=\"https://www.npmjs.com/package/@ygoe/msgpack\">@ygoe/msgpack</a></li></ul><p>I tried both and chose the latter because itâ€™s <a href=\"https://bundlephobia.com/scan-results?packages=msgpack-lite,@ygoe/msgpack\">smaller in bundle size, according to Bundlephobia</a>. Iâ€™m not choosing based on performance because Iâ€™ve confirmed that both are <a href=\"https://twitter.com/cheeaun/status/1109818670711078912\">way faster</a> than <code>JSON.parse</code>. Instead of more than 10 seconds, the data is decoded in <strong>about 3 seconds</strong> or less. The file size is smaller too, at around <strong>30 MB</strong> but after gzipped, it becomes the same as the gzipped JSON file at roughly <strong>5 MB</strong>. Too bad, I was hoping it'll be even smaller ğŸ˜….</p><p>In the previous dataset, I noticed a few discrepancies such as two or more trees, with different IDs, located at the <em>exact</em> same coordinates. This time, I try to clean it up and remove duplicates, partially with the hopes of reducing the file size.</p><p>It might sound silly but Iâ€™m actually performing <em>strict</em> comparison of <em>exact</em> coordinates. Iâ€™m not kidding that there's a few trees with <em>exactly</em> the same coordinates up to every single decimal place. Imagine two trees with the coordinates of 103.702059 longitude and 1.406719 latitude, with not a single difference in the decimals. ğŸ˜…</p><p>Someone told me before that there could be a tree growing on top of another tree, but I quiteâ€¦ doubt it. ğŸ¤¨</p><figure><video src=\"https://cheeaun.com/blog/videos/software/exploretrees-sg-chunk-command-remove-duplicate-trees.mp4#t=0.1\" controls=\"\" playsinline=\"\"></video></figure><p>I checked the data, and could find other similarities in the name and species name. Okay, I could be wrong but I <a href=\"https://twitter.com/cheeaun/status/1110175312225030144\">decided to remove the potential duplicates</a> anyway, since this affects the map user interface. Two overlapping tree dots on a map poses quite a challenge, especially for visualization and user interactions. I have high suspicion that the original dataset actually comes from multiple datasets, via different agencies, which could explain this phenomenon.</p><p>The final gzipped file size remains the same ğŸ˜….</p><h2>Pushing the limits, again</h2><p>As the dataset is finalised with decent loading and decoding performance, I proceed to reimplement most of what I did in the first version using <a href=\"https://docs.mapbox.com/mapbox-gl-js/api/\">Mapbox GL JS</a>, with Deck.gl instead.</p><p>In the original implementation with Mapbox GL JS:</p><ul><li>Every tree dot is styled via the <a href=\"https://docs.mapbox.com/mapbox-gl-js/style-spec/#layers-circle\"><code>circle</code></a> layer.</li><li>Pure client-side solution is impossible if there are <a href=\"https://docs.mapbox.com/help/troubleshooting/working-with-large-geojson-data/#even-bigger-data\">over 500,000 data points</a>, thus the server-side solution via Mapbox Studio.</li><li>Not all 500,000+ trees are rendered on the map in higher zoom levels because thatâ€™s how the vector tiles work; dropping or coalescing features on every zoom level if the limits on the tiles are exceeded.</li></ul><p>Hereâ€™s a code example:</p><pre><code>map.addLayer({\n  id: 'trees',\n  type: 'circle',\n  source: 'trees-source',\n  'source-layer': 'trees',\n  paint: {\n    'circle-color': [\n      'case',\n      ['all', ['to-boolean', ['get', 'flowering']], ['to-boolean', ['get', 'heritage']]], 'magenta',\n      ['to-boolean', ['get', 'flowering']], 'orangered',\n      ['to-boolean', ['get', 'heritage']], 'aqua',\n      'limegreen'\n    ],\n    'circle-opacity': [\n      'case',\n      ['to-boolean', ['get', 'flowering']], 1,\n      ['to-boolean', ['get', 'heritage']], 1,\n      .5\n    ],\n    'circle-radius': [\n      'interpolate', ['linear'], ['zoom'],\n      8, .75,\n      14, ['case',\n        ['to-boolean', ['get', 'flowering']], 3,\n        ['to-boolean', ['get', 'heritage']], 3,\n        1.25\n      ],\n      20, ['case',\n        ['to-boolean', ['get', 'flowering']], 10,\n        ['to-boolean', ['get', 'heritage']], 10,\n        6\n      ]\n    ],\n    'circle-stroke-width': [\n      'interpolate', ['linear'], ['zoom'],\n      11, 0,\n      14, 1,\n    ],\n    'circle-stroke-color': 'rgba(0,0,0,.25)',\n  },\n});\n</code></pre><p>For the new implementation with Deck.gl:</p><ul><li><p>The dots are rendered with <a href=\"https://deck.gl/#/documentation/deckgl-api-reference/layers/scatterplot-layer\"><code>ScatterPlotLayer</code></a>. May look the same as the former but the styles are written differently.</p></li><li><p>Pure client-side solution becomes possible. The <a href=\"https://deck.gl/#/documentation/developer-guide/performance-optimization?section=general-performance-expectations\">documentation</a> quotes:</p><blockquote><p>On 2015 MacBook Pros with dual graphics cards, most basic layers (like <code>ScatterplotLayer</code>) renders fluidly at 60 FPS during pan and zoom operations up to about 1M (one million) data items, with framerates dropping into low double digits (10-20FPS) when the data sets approach 10M items.</p></blockquote></li><li><p><strong>All</strong> trees are rendered in <strong>all</strong> zoom levels.</p></li></ul><p>The new code example:</p><pre><code>new MapboxLayer({\n  id: 'trees',\n  type: ScatterplotLayer,\n  opacity: 1,\n  radiusMinPixels: .1,\n  radiusMaxPixels: 5,\n  lineWidthUnits: 'pixels',\n  getLineWidth: 1,\n  getLineColor: [0,0,0,200],\n  getRadius: (d) =&gt; (d.flowering || d.heritage) ? 100 : 3,\n  getFillColor: (d) =&gt; {\n    if (d.flowering &amp;&amp; d.heritage) return colorName2RGB('magenta');\n    if (d.flowering) return colorName2RGB('orangered');\n    if (d.heritage) return colorName2RGB('aqua');\n    return colorName2RGB('green');\n  },\n});\n</code></pre><p>Yeap, shorter.</p><p>I have to create a new function called <code>colorName2RGB</code> to convert color names (<code>orangered</code>, <code>aqua</code>, etc) to RGB values in array form (<code>[R,G,B]</code>), because Deck.gl doesnâ€™t support them. This function is surprisingly simple because it uses <code>canvas</code>â€™s magic <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/fillStyle\"><code>fillStyle</code></a> property to convert a <code>CSS</code> color, instead of a lookup table, thanks to this <a href=\"https://stackoverflow.com/a/47355187/20838\">StackOverflow answer by <em>JayB</em></a>.</p><p>Everything became <a href=\"https://twitter.com/cheeaun/status/1114532995799478272\">crazy <em>smooth</em></a>.</p><figure><video src=\"https://cheeaun.com/blog/videos/web/exploretrees-sg-zoom-in-smooth-af.mp4#t=0.1\" controls=\"\" playsinline=\"\"></video></figure><p>The reimplementation didnâ€™t take long. There were some tiny differences in how the circle scales for different zoom levels but not significant enough for anyone to notice.</p><p>Deck.gl has yet again <em>amazed</em> me with its powerful features and performance. Honestly, I always get wowed every single time by how much I can achieve with this library! And I didn't stop there ğŸ˜‰.</p><p>This was my previous <strong>failed</strong> attempt:</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/software/3d-trees-girth-height-map-singapore@2x.png\" alt=\"3D trees rendered based on girth and height, on a map, in Singapore\" width=\"1392\" height=\"839\" loading=\"lazy\"></figure><p>Itâ€™s a failed attempt mainly due to performance. It was <strong>too darn laggy</strong> rendering <em>all</em> the 3D tree trunks! I also suspect that some girth measurements were wrong, which you could see that one huge hexagon in the image above, at Fort Canning Park. This was done with Mapbox GL JSâ€™s 3D extrusion features.</p><p>This is my <a href=\"https://twitter.com/cheeaun/status/1114696975515963398\">second attempt</a>, with Deck.gl:</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-3d-tree-trunks-1.jpg\" alt=\"ExploreTrees.SG showing 3D tree trunks\" width=\"1934\" height=\"920\" loading=\"lazy\"></figure><p>Those orange dots are the tree trunks in 3D. Lets zoom in.</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-3d-tree-trunks-2.jpg\" alt=\"ExploreTrees.SG showing 3D tree trunks, zoomed-in\" width=\"1704\" height=\"1434\" loading=\"lazy\"></figure><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-3d-tree-trunks-3.jpg\" alt=\"ExploreTrees.SG showing 3D tree trunks, further zoomed-in\" width=\"1362\" height=\"1212\" loading=\"lazy\"></figure><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-3d-tree-trunks-4.jpg\" alt=\"ExploreTrees.SG showing 3D tree trunks, much further zoomed-in\" width=\"1192\" height=\"1412\" loading=\"lazy\"></figure><p>This attempt is about <strong>3 to 4 times faster</strong> in rendering <em>everything</em> ğŸ˜± (based on my perception). <strong>But</strong>, it still lags when panning around in higher levels ğŸ˜¢.</p><p>Ugh, I feel like Iâ€™m on roller coaster ride when things become fast, super fast, then slow again, then fast again, and then end up slow again ğŸ˜–. Technically itâ€™s my own fault. Repeatedly, I did try to make it fast and <em>then</em> purposely make it slow again. I have no idea why I keep doing this ğŸ˜‚</p><p>Anyway, I had an idea on how to make it fast ğŸ˜. I limit this 3D mode to higher zoom levels and then filter the list of trees based on the mapâ€™s geographical bounds. Like this:</p><pre><code>const bounds = map.getBounds();\n\nconst results = ... // magically filter the list of trees based on bounds\n\ntrees3DLayer.setProps({\n  data: trees3Dify(results),\n});\n</code></pre><p>The returned value of <code>map.getBounds()</code> is the smallest bounds that encompasses the visible region of the map. Instead of rendering 500,000+ trees, it can be made to only render few thousands instead.</p><p>Basically this not only solves the performance problem, but also makes sense. Thereâ€™s no point rendering 3D trees on lower zoom levels anyway since theyâ€™ll all look like small dots. Users still have to zoom in to see the 3D trunks in detail, which is the same reason why 3D buildings are only visible in higher zoom levels on maps like Google Maps and Apple Maps.</p><p>Thanks to this, itâ€™s <a href=\"https://twitter.com/cheeaun/status/1114833009289469952\">fast again</a> ğŸ˜¬.</p><figure><video src=\"https://cheeaun.com/blog/videos/web/exploretrees-sg-3d-tree-trunks-no-lag.mp4#t=0.1\" controls=\"\" playsinline=\"\"></video></figure><p>The right side is the Developer Tools Console, logging the number of 3D trees rendered every time the map is zoomed, panned or rotated. Itâ€™s quite noticeable that thereâ€™s completely no lag at all when panning around. The 3D trees outside of the bounds will only start rendering after the pan, zoom or rotate ends.</p><p><strong>Perfect</strong>. Whatâ€™s left for me is to finish up the remaining reimplementation, remove all the old code, choose a better color for these tree trunks and wrap up!</p><figure><img src=\"https://cheeaun.com/blog/images/figures/diagram/thinking-3d-tree-trunks@2x.jpg\" alt=\"Thinking about 3D tree trunks\" width=\"562\" height=\"300\" loading=\"lazy\"></figure><p>At first, I wanted to color the trunks as brown but itâ€™s too dark and doesnâ€™t contrast well with the dark map tiles. This explains why I choose brighter brown or orange as my first attempt. And then I changed the color to white because itâ€™s still doesnâ€™t <em>feel</em> right somehowâ€¦</p><p>Yesâ€¦ 3D tree trunks look kind of weird, right?</p><p>I thought to myself, <strong>what was I trying to do again?</strong> Whatâ€™s the purpose of the 3D renderings? Isnâ€™t 2D enough for this visualization? I guess that drawing 3D trees on a map would be cool but didnâ€™t really think much after that.</p><p>But what makes them look weird?</p><p>Oh! The tree <a href=\"https://en.wikipedia.org/wiki/Crown_(botany)\">crowns</a>! It looks weird because itâ€™s <em>incomplete</em>. Wait, the problem is that I donâ€™t have the crown data, so how am I going to draw the tree crowns? Depending on the tree species or families, I might need to draw different shapes of crowns, which can be <em>a lot</em> of work ğŸ˜….</p><p>So I start to think, whatâ€™s the simplest form of a tree crown that is achievable? Of course, <strong>another cylinder</strong>.</p><p>I did a few <a href=\"https://twitter.com/cheeaun/status/1119443171031703552\">quick sketches</a> during my free time:</p><figure><img src=\"https://cheeaun.com/blog/images/photos/objects/exploretrees-sg-logo-tree-trunk-crown-sketches.jpg\" alt=\"ExploreTrees.SG logo and tree trunk with crown sketches\" width=\"1024\" height=\"768\" loading=\"lazy\"></figure><p>I have the height information of the trees, but it doesnâ€™t necessarily mean the height of the trunks themselves. I could â€œchop offâ€ the trunk to about 75% and leave the rest for the crown. The crown could take up 50% of the height so that it looks like itâ€™s <em>covering</em> the trunk. As for the radius of the crown, I can roughly measure it based on the height as well. From my trials and errors, I found the sweet spot for the radius to be roughly 40% of the height.</p><p>Sounds like <em>complicated</em> math, butâ€¦ <strong><a href=\"https://twitter.com/cheeaun/status/1114866910682681344\">voilÃ !</a></strong></p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-faux-3d-trees-1.jpg\" alt=\"ExploreTrees.SG faux 3D trees\" width=\"1518\" height=\"1438\" loading=\"lazy\"></figure><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-faux-3d-trees-2.png\" alt=\"ExploreTrees.SG faux 3D trees, zoomed-in\" width=\"1658\" height=\"1408\" loading=\"lazy\"></figure><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-faux-3d-trees-3.png\" alt=\"ExploreTrees.SG faux 3D trees, further zoomed-in\" width=\"1618\" height=\"1374\" loading=\"lazy\"></figure><p>This is the moment when I felt that my efforts have finally becoming fruitful. Little did I know that the crowns actually make such a huge difference!</p><p>To be honest, I got super excited when this actually works. I tried to finish up the work and ensuring feature parity with the old implementation. It reached a point where it's <a href=\"https://twitter.com/cheeaun/status/1114919843541573632\"><em>almost</em> complete</a>.</p><figure><video src=\"https://cheeaun.com/blog/videos/web/exploretrees-sg-3d-trees-almost-complete.mp4#t=0.1\" controls=\"\" playsinline=\"\"></video></figure><p>Iâ€™ve also enabled <a href=\"https://twitter.com/cheeaun/status/1115060661401182208\">3D buildings</a>, for a more <em>complete</em> picture.</p><figure><video src=\"https://cheeaun.com/blog/videos/web/exploretrees-sg-3d-trees-3d-buildings.mp4#t=0.1\" controls=\"\" playsinline=\"\"></video></figure><p>â€¦and <a href=\"https://twitter.com/cheeaun/status/1115630822764105728\">more photos</a>!</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-faux-3d-trees-4.png\" alt=\"ExploreTrees.SG faux 3D trees â€” overlapping tree crowns\" width=\"1074\" height=\"720\" loading=\"lazy\"></figure><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-faux-3d-trees-5.png\" alt=\"ExploreTrees.SG faux 3D trees â€” cute tiny trees\" width=\"870\" height=\"710\" loading=\"lazy\"></figure><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-faux-3d-trees-6.png\" alt=\"ExploreTrees.SG faux 3D trees â€” huge trees and tiny trees together\" width=\"1136\" height=\"836\" loading=\"lazy\"></figure><p>Look at those cute little trees! ğŸ˜</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-faux-3d-trees-7.png\" alt=\"ExploreTrees.SG faux 3D trees â€” long queue of trees\" width=\"1054\" height=\"820\" loading=\"lazy\"></figure><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-faux-3d-trees-8.png\" alt=\"ExploreTrees.SG faux 3D trees â€” curved line of trees\" width=\"1038\" height=\"806\" loading=\"lazy\"></figure><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-faux-3d-trees-9.png\" alt=\"ExploreTrees.SG faux 3D trees â€” tree formations in context with surrounding 3D buildings\" width=\"1102\" height=\"856\" loading=\"lazy\"></figure><p>Nearby 3D buildings tend to give a pretty <a href=\"https://twitter.com/cheeaun/status/1115632732481019916\">realistic context</a> to the 3D trees around them. In a way, it feels like thereâ€™s a pattern on how these trees are planted based on the surrounding geography ğŸ¤”.</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-faux-3d-trees-10.png\" alt=\"ExploreTrees.SG faux 3D trees â€” trees on Changi Beach Park\" width=\"1092\" height=\"886\" loading=\"lazy\"></figure><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-faux-3d-trees-11.png\" alt=\"ExploreTrees.SG faux 3D trees â€” trees clashing with buildings\" width=\"1042\" height=\"810\" loading=\"lazy\"></figure><p>This image above shows one of the data mismatch cases, near Cecil Street, where the trees are no longer there and an interim food centre is built in this area.</p><p>Alright, Iâ€™m almost done. The 2D tree markers are working. Visualization filters work. 3D trees perform really well.</p><p>Just <em>one</em> thing left: <strong>laggy</strong> blue <em>marker highlighter</em> and tree information <em>hover cards</em>, as rendered on the videos above. On desktop browsers, when the mouse cursor hovers over a tree, the blue marker highlighter will appear around it, with the hover card popping out from the bottom right of the page. Thereâ€™s a significant lag when the cursor moves across multiple trees on the map as the user interface is trying to keep up.</p><figure><img src=\"https://cheeaun.com/blog/images/figures/diagram/exploretrees-sg-marker-highlighter-hover-card@2x.png\" alt=\"ExploreTrees.SG marker highlighter and hover card\" width=\"490\" height=\"311\" loading=\"lazy\"></figure><p>I tried three attempts.</p><p>My <strong>first</strong> piece of code was using the <a href=\"https://docs.mapbox.com/mapbox-gl-js/api/#map.event:mouseover\"><code>mousemove</code> event</a> from Mapbox GL JS. When the event is fired, a specific layer from the map can be queried and the marker or feature information can be extracted to be displayed as part of the hover card. The query is done by converting the pixel coordinates of the cursor to the actual map coordinates in latitude &amp; longitude, and then find the nearest map feature from the coordinates. This operation is quite tedious â€” the <code>mousemove</code> event fires too often, there are way too many features under the cursor and every single call is blocking the UI thread, thus affecting the rendering speed of the marker highlighter and the hover card.</p><p>My <strong>second</strong> attempt was using Deck.glâ€™s powerful <a href=\"https://deck.gl/#/documentation/developer-guide/adding-interactivity\">picking engine</a>, which uses something called the <a href=\"https://deck.gl/#/documentation/developer-guide/writing-custom-layers/picking\">Color Picking Technique</a>:</p><blockquote><p>Rather than doing traditional ray-casting or building octrees etc in JavaScript, deck.gl implements picking on the GPU using a technique we refer to as \"color picking\". When deck.gl needs to determine what is under the mouse (e.g. when the user moves or clicks the pointer over the deck.gl canvas), all pickable layers are rendered into an off-screen buffer, but in a special mode activated by a GLSL uniform. In this mode, the shaders of the core layers render picking colors instead of their normal visual colors.</p></blockquote><p>Honestly, I have no idea how this works. I roughly get it that the engine tries to pick the color under the cursor and somehow manage to find the relevant feature which matches the color?!? But how?</p><p>Anyway, Iâ€™ve tried it and this method doesnâ€™t work too. Everythingâ€™s <em>still</em> slow ğŸ˜­.</p><p>So, lo and behold my <strong>third</strong> attempt using a spatial index for points with a library called <a href=\"https://github.com/mourner/geokdbush\"><code>geokdbush</code></a>:</p><blockquote><p>A geographic extension for <a href=\"https://github.com/mourner/kdbush\">kdbush</a>, the fastest static spatial index for points in JavaScript.</p><p>It implements fast <a href=\"https://en.wikipedia.org/wiki/Nearest_neighbor_search\">nearest neighbors</a> queries for locations on Earth, taking Earth curvature and date line wrapping into account. Inspired by <a href=\"https://github.com/darkskyapp/sphere-knn\">sphere-knn</a>, but uses a different algorithm.</p></blockquote><p>I think itâ€™s pretty cool because itâ€™s written by <a href=\"https://github.com/mourner\">Vladimir Agafonkin</a>, the creator of <a href=\"https://leafletjs.com/\">Leaflet</a>.</p><p>Hereâ€™s a rough code snippet:</p><pre><code>const index = new KDBush(data, (p) =&gt; p.position[0], (p) =&gt; p.position[1]);\n...\nconst nearestPoints = geokdbush.around(index, point.lng, point.lat, 1, radius);\n</code></pre><p>The <code>geokdbush.around</code> method returns an array of the closest points from a given location in order of increasing distance. It has optional arguments to set custom maximum results, maximum distance in kilometers to search within, and even an additional function to further filter the results! ğŸ¤¯</p><p>In fact, these methods are so useful that I also use it for filtering the rendering of the 3D trees based on the map bounds (in the beginning, for the <code>trees3Dify</code> call).</p><p>The result is <a href=\"https://twitter.com/cheeaun/status/1116960702118318082\"><strong>insanely fast</strong></a>. âš¡ï¸</p><figure><video src=\"https://cheeaun.com/blog/videos/web/exploretrees-sg-super-fast-hovers.mp4#t=0.1\" controls=\"\" playsinline=\"\"></video></figure><p>Even works in <a href=\"https://twitter.com/cheeaun/status/1116960752122777601\">3D mode</a>:</p><figure><video src=\"https://cheeaun.com/blog/videos/web/exploretrees-sg-super-fast-hovers-3d.mp4#t=0.1\" controls=\"\" playsinline=\"\"></video></figure><p>Iâ€™m quite satisfied with this.</p><p>But I think I can <strong>do more</strong>. ğŸ’ª</p><h2>Plus ultra</h2><p>Initially I have an idea for getting a listing of all tree species mapped to their own crown shape patterns. I couldnâ€™t find such list unfortunately ğŸ˜­.</p><p>My research led me to few subjects like <a href=\"https://openoregon.pressbooks.pub/forestmeasurements/chapter/5-3-crown-classes/\">tree crown classes</a> and I especially like this diagram from <a href=\"https://www.toppr.com/guides/science/forest-our-lifeline/structure-of-forest/\">Structures of Forest</a>:</p><figure><img src=\"https://cheeaun.com/blog/images/figures/diagram/crown-of-tree.jpg\" alt=\"Crown of tree diagram, showing Pyramidal, Full-crowned, Vase, Fountain, Spreading, Layered, Columnar and Weeping\" width=\"475\" height=\"462\" loading=\"lazy\"></figure><p>These are the various crown shapes of trees and I think I only covered the â€œfull-crownedâ€ type, with blocky cylinders. The other crowns would be a bit difficult to model in 3Dâ€¦</p><p>Similar to how the tree trunks are rendered, the tree crowns are rendered with deck.glâ€™s <a href=\"https://deck.gl/#/documentation/deckgl-api-reference/layers/solid-polygon-layer\">SolidPolygonLayer</a>, which works like <a href=\"https://deck.gl/#/documentation/deckgl-api-reference/layers/polygon-layer\">PolygonLayer</a> but without strokes. Extrusion is enabled from the <code>extruded</code> option combined with z-indices of the coordinates. The circle shape is formed with <a href=\"https://turfjs.org/docs/#circle\">@turf/circle</a>. Elevation is performed via the <code>getElevation</code> accessor.</p><figure><img src=\"https://cheeaun.com/blog/images/figures/diagram/exploretrees-sg-polygon-extrusion-elevation@2x.png\" alt=\"Coordinates forming a polygon, with extrusion and elevation\" width=\"562\" height=\"400\" loading=\"lazy\"></figure><p>This is <strong>the basics</strong>.</p><p>Creating complex polygons for all the different tree crowns would be too complicated for me, both computationally <em>and</em> mathematically ğŸ˜µ.</p><p>While developing this project, Iâ€™ve been following the updates on the then-upcoming <a href=\"https://github.com/uber/deck.gl/blob/master/CHANGELOG.md#deckgl-v70\">version 7.0 of Deck.g</a>l. The changes that caught my attention was the (re-)introduction of <a href=\"https://github.com/uber/deck.gl/issues/2890\"><code>SimpleMeshLayer</code></a> and <a href=\"https://github.com/uber/deck.gl/issues/2871\"><code>ScenegraphLayer</code></a>, which allows the rendering of actual 3D models in formats such as <a href=\"https://en.wikipedia.org/wiki/Wavefront_.obj_file\">OBJ</a>, <a href=\"https://en.wikipedia.org/wiki/PLY_(file_format)\">PLY</a> and <a href=\"https://en.wikipedia.org/wiki/GlTF\">glTF</a>. This meansâ€¦ I can put <em>real</em> tree models on the map! ğŸ˜±</p><p>Wait the minute, I donâ€™t have a species-to-crown-type mapping yet, so rendering a super realistic full-crowned tree for every single tree would be kind of weird, especially for those tiny little trees. Even if I have the mapping, it would take a gargantuan effort for me to code the species-specific crowns for all 500,000+ trees, manage all the 3D model files, <em>and</em> tune the asset loading &amp; map rendering performance at the same time!</p><p>There <em>has</em> to be some compromise here. I want to replace the cylinder tree crowns with something more realistic <strong>but</strong> cannot be <em>too</em> realistic. So it should be <strong>semi-realistic</strong>, right?</p><p>I read through the <a href=\"https://deck.gl/#/documentation/deckgl-api-reference/layers/simple-mesh-layer\">documentation</a> and noticed this interesting piece of code from the example:</p><pre><code>import {CubeGeometry} from 'luma.gl'\n</code></pre><p>Thatâ€™s one of scenegraph model nodes provided by <a href=\"https://luma.gl/#/\">luma.gl</a>. Pretty neat.</p><p>They are like pre-made 3D objects that can be used like, as what it described, WebGL components. One of the geometries that I found is the <a href=\"https://luma.gl/#/documentation/api-reference/geometry-nodes/sphere\">SphereGeometry</a>, which looks like what I need. Or perhaps, a sphere is what I think would be a better alternative than a cylinder, right? ğŸ¤”</p><p>Not only that I can create a sphere object with this, I can also apply a texture on it with the <code>texture</code> property for <code>SimpleMeshLayer</code>.</p><p>Hereâ€™s a code snippet:</p><pre><code>const treesCrownLayer = new MapboxLayer({\n  id: 'trees-crown',\n  type: SimpleMeshLayer,\n  texture: document.getElementById('leaves'),\n  mesh: new SphereGeometry(),\n  ...\n});\n</code></pre><p>The <code>texture</code> property accepts one of these 3 types of value:</p><ul><li>A luma.gl <code>Texture2D</code> instance</li><li>An <code>HTMLImageElement</code></li><li>A URL string to the texture image</li></ul><p>So the <code>document.getElementById('leaves')</code> code above is a reference to an <code>img</code> element in the HTML page. I use this method to <em>preload</em> the image instead of lazy-load it during runtime.</p><p>As for the image, I <em>googled</em> and managed to sift through <em>hundreds</em> of images to find <strong>one</strong> â€œleavesâ€ texture image from <a href=\"https://opengameart.org/content/dims-enviromental-and-architectural-textures\">Dim's environmental and architectural textures</a>. Honestly, itâ€™s not easy to find a <em>good</em> texture image at all ğŸ˜‚, but luckily there are existing available resources mostly for game development ğŸ˜€.</p><p>Hereâ€™s the moment of truth ğŸ¤:</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-3d-realistic-trees-1.jpg\" alt=\"ExploreTrees.SG 3D realistic trees\" width=\"2048\" height=\"1282\" loading=\"lazy\"></figure><p><strong>Oh my god, It works!!</strong> ğŸ˜±ğŸ˜±ğŸ˜±</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-3d-realistic-trees-2.jpg\" alt=\"ExploreTrees.SG 3D realistic trees â€” tree crowns with less vertices\" width=\"1390\" height=\"1316\" loading=\"lazy\"></figure><p>For this image, I tried playing around with the number of vertices. If itâ€™s reduced, the sphere will have less triangular faces and look less spherical. I kind of suspect that reducing the number of vertices might improve performance but doesnâ€™t seem to affect much.</p><p>Anyway, before I get too happy with this result, there are few problems:</p><ul><li>The trees look a bit too dark, so might need some sort of lighting. Maybe use brighter colors too.</li><li>The tree crown need to be â€œsee-throughâ€, to simulate the empty spaces between the leaves.</li><li>The leaves on the crown are too big, especially when zoomed in. Iâ€™ll need to make them smaller.</li></ul><p>Using <a href=\"https://affinity.serif.com/en-gb/photo/\">Affinity Photo</a> and <a href=\"https://affinity.serif.com/en-gb/designer/\">Affinity Designer</a>, I made some adjustments from the original texture image (top left):</p><figure><img src=\"https://cheeaun.com/blog/images/figures/diagram/tree-leaves-texture-image-masked-flipped-repeated-pattern@2x.jpg\" alt=\"Tree leaves texture image being masked and flipped into a repeated pattern\" width=\"460\" height=\"659\" loading=\"lazy\"></figure><p>First, I select the dark areas between the leaves and make them alpha-transparent. To reduce the size of the leaves, I make the image bigger instead, by flipping it 3 times, creating a repeatable leaves image pattern.</p><p>The results:</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-3d-realistic-trees-3.jpg\" alt=\"ExploreTrees.SG 3D realistic trees, zoomed out with surrounding 3D buildings\" width=\"1600\" height=\"1200\" loading=\"lazy\"></figure><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-3d-realistic-trees-4.jpg\" alt=\"ExploreTrees.SG 3D realistic trees â€” trees at road intersection\" width=\"1600\" height=\"1188\" loading=\"lazy\"></figure><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-3d-realistic-trees-5.jpg\" alt=\"ExploreTrees.SG 3D realistic trees â€” highlighted tree and zoomed in\" width=\"1600\" height=\"1188\" loading=\"lazy\"></figure><p>Not bad. The leaves are smaller and itâ€™s possible to see the tree trunk hiding <em>inside</em> the crown. ğŸ‘€</p><p>As for the lighting, I use the new lighting effects system <a href=\"https://medium.com/vis-gl/introducing-deck-gl-v7-0-c18bcb717457\">introduced in deck.gl v7.0</a>, particularly the <a href=\"https://deck.gl/#/documentation/deckgl-api-reference/lights/ambient-light\"><code>AmbientLight</code></a> source and the new experimental <a href=\"https://deck.gl/#/documentation/deckgl-api-reference/lights/sun-light\"><code>SunLight</code></a> source. <code>SunLight</code> is a variation of <code>DirectionalLight</code> which is automatically set based on a UTC time and the current viewport. In other words, it <strong>simulates the sun</strong> by calculating the sun position with a JavaScript library called <a href=\"https://github.com/mourner/suncalc\">SunCalc</a> (again, created by Vladimir Agafonkin, creator of Leaflet ğŸ¤©).</p><p>Coincidentally as I was <a href=\"https://www.aa.quae.nl/en/reken/zonpositie.html\">researching on how the code and formula work</a>, I saw Vladimir <a href=\"https://twitter.com/mourner/status/1120748294190141440\">tweeting</a> about his tiny <a href=\"https://observablehq.com/@mourner/sun-position-in-900-bytes\">900-byte function to calculate the position of the Sun</a>! ğŸ˜± If Iâ€™m not mistaken, itâ€™s like a simplified version of SunCalc.</p><p>Without further ado, I implemented them all, this way:</p><pre><code>const phaseColor = getPhaseColor(timestamp);\nconst ambientLight = new AmbientLight({\n  intensity: phaseColor === 'dark' ? 1 : 1.5,\n});\nconst sunLight = new SunLight({\n  timestamp,\n  intensity: phaseColor === 'dark' ? .5 : 2,\n});;\nconst lightingEffect = new LightingEffect({\n  ambientLight,\n  sunLight,\n});\ntreesCrownLayer.deck.setProps({\n  effects: [lightingEffect],\n});\n</code></pre><p>The light intensities reduce when the sun phase is â€œdarkâ€ to simulate night time.</p><p>Before ğŸ”…:</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-3d-realistic-trees-lighting-before.jpg\" alt=\"ExploreTrees.SG 3D realistic trees â€” the lighting before\" width=\"1136\" height=\"640\" loading=\"lazy\"></figure><p>After ğŸ”†:</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-3d-realistic-trees-lighting-after.jpg\" alt=\"ExploreTrees.SG 3D realistic trees â€” the lighting after\" width=\"1136\" height=\"640\" loading=\"lazy\"></figure><p>Looks much better!</p><p>Hereâ€™s <a href=\"https://twitter.com/cheeaun/status/1124981208427810816\">a time-lapse of the sun lighting</a> on the trees, to show how the (sun) light direction changes based on time. Also, itâ€™s not affected by user's local time and will always be in actual Singapore time, since the formula depends on location coordinates instead of time.</p><figure><video src=\"https://cheeaun.com/blog/videos/web/exploretrees-sg-sun-lighting.mp4#t=0.1\" controls=\"\" loop=\"\" playsinline=\"\"></video></figure><p>Unfortunately, the lighting transition from night to day and day to night is kind of abrupt for now. Just in case someone stays on the site for too long, Iâ€™ve also added a time interval to update the lighting every 10 minutes.</p><p>Along the way, Iâ€™ve added a few useful POIs (Points of Interest) that are <a href=\"https://www.nparks.gov.sg/gardens-parks-and-nature\">listed on NParks</a>, which include these categories of places:</p><ul><li>Parks</li><li>Community gardens</li><li>Heritage roads</li><li>Skyrise greenery</li></ul><p>On their <a href=\"https://www.nparks.gov.sg/gardens-parks-and-nature\">site</a>, it looks like this:</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/nparks-site-parks-community-gardens-heritage-trees-heritage-road-skyrise-greenery@2x.png\" alt=\"NParks site showing parks, community gardens, heritage trees, heritage road and skyrise greenery\" width=\"677\" height=\"423\" loading=\"lazy\"></figure><p>On ExploreTrees.SG:</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-parks-community-gardens-skyrise-greenery@2x.png\" alt=\"ExploreTrees.SG showing parks, community gardens and skyrise greenery\" width=\"640\" height=\"480\" loading=\"lazy\"></figure><p>Besides the POIs, Iâ€™ve also made the train stations and bus stops more prominent to guide navigation and exploration. These markers only appear on higher zoom levels as they are only useful in those levels and to prevent clutter on the map.</p><p>As a side quest, I took this chance to try out <a href=\"https://lit-html.polymer-project.org/\">lit-html</a> for the hover card, replacing the constant <code>innerHTML</code> layout-trashing (destroying and rebuilding the content on every hover event).</p><h2>The final boss</h2><p>Despite the fact that Iâ€™ve ticked off <em>all</em> the checkboxes in my todos for this project, thereâ€™s one problem that I ignore since the beginning of this exercise.</p><p><strong>It doesnâ€™t work well on mobiles.</strong> ğŸ˜</p><p>There are a few issues:</p><ul><li>MessagePack decoding crashes on Mobile Safari. When I try switch it to JSON format, the browser didnâ€™t crash but it takes a significant amount of time to load. Either way, itâ€™s a pretty bad user experience.</li><li>Even after everything is loaded successfully, Mobile Safari will randomly crash after few minutes of panning and zooming on the map. Iâ€™ve tried asking a friend to try the site on an iPad, which I suspect has more memory and processing power than iPhone, yet the site still crashes ğŸ˜­.</li><li>The site doesnâ€™t crash on Chrome Android but still kind of laggy. ğŸŒ</li></ul><p>Most-likely suspicion could be the <strong>memory pressure</strong>, as highlighted by Deck.glâ€™s <a href=\"https://deck.gl/#/documentation/developer-guide/performance-optimization\">documentation on performance</a>:</p><blockquote><p>Modern phones (recent iPhones and higher-end Android phones) are surprisingly capable in terms of rendering performance, but are considerably more sensitive to memory pressure than laptops, resulting in browser restarts or page reloads. They also tend to load data significantly slower than desktop computers, so some tuning is usually needed to ensure a good overall user experience on mobile.</p></blockquote><p>I guess loading a 5MB compressed file, which uncompresses into a 30MB file, that loads 500,000+ trees on a WebGL-powered 3D-rendered map is justâ€¦ too much? ğŸ˜</p><p>Iâ€™ve tried dozens of ways to fix this, like:</p><ul><li>Reduce the number of layers on the map.</li><li>Reduce the number of polygons on the map.</li><li>Remove some features and code that might use a lot of memory.</li><li>Apply micro-optimisations that I thought would help.</li><li>Reduce number of trees by using cluster mode with <a href=\"https://github.com/mapbox/supercluster\"><code>supercluster</code></a>, which kind of defeats the purpose why I build this in the first place.</li></ul><p>Nothing works. Itâ€™s pretty daunting ğŸ˜©.</p><p>This is the only thing that blocks me from launching this new version of ExploreTrees.SG and I have to make the call.</p><figure><img src=\"https://cheeaun.com/blog/images/photos/objects/exploretrees-sg-visitor-v1-v2.jpg\" alt=\"ExploreTrees.SG visitor flow for version 1 and version 2\" width=\"800\" height=\"600\" loading=\"lazy\"></figure><p>After days of contemplating, I decided to <em>not</em> replace the version 1.0 of ExploreTrees.SG and instead, slot in the version 2.0 <strong>together</strong> with it. The old version 1.0 works fine and seems more stable on mobile browsers. The new version works fine on desktop browsers but <em>not</em> the iPad. Iâ€™m not sure about Android tablets so Iâ€™ll assume theyâ€™re slightly better or worse than iPad. ğŸ¤·â€â™‚ï¸</p><p>On version 1.0, all the tree data are served from <a href=\"https://www.mapbox.com/mapbox-studio/\">Mapbox Studio</a>, as vector <a href=\"https://docs.mapbox.com/studio-manual/reference/tilesets/\">tilesets</a>. They are <em>partially</em> loaded based on zoom levels, so not everything is shown at once. This probably helps in reducing memory pressure, using less bandwidth, and having better performance.</p><p>On version 2.0, which I kept pushing the limits, <strong>all</strong> the trees data are loaded in the web browser, so thereâ€™s no more round trip to the server. Technically itâ€™s pure client-side and uses a lot of bandwidth and all the power from the userâ€™s machine to render everything nicely.</p><p>I needed a way to switch between the versions based on certain device capabilities.</p><p>Thereâ€™s no way for me to detect the device's or browserâ€™s ability to handle large memory pressure. Thereâ€™s also no way to detect possible crashes on a web app <em>before</em> it could crash. User agent string detection wonâ€™t work here either.</p><p>Since thereâ€™s no reliable way to detect these conditions, I applied touch detection instead:</p><pre><code>const isTouch = 'ontouchstart' in window || navigator.msMaxTouchPoints;\nconst hqHash = /#hq/.test(location.hash);\nconst renderingMode = !hqHash &amp;&amp; isTouch ? 'low' : 'high';\n</code></pre><p>I made a few assumptions:</p><ul><li>Most modern mobile phones have touch screens.</li><li>Older phones wonâ€™t be able to load the site anyway since it uses WebGL (sorry ğŸ™‡â€â™‚ï¸).</li><li>Even though iPad is quite powerful, it also has a touch screen so this detection will rule it out.</li><li>The only exception would be desktop computers with touch screens.</li></ul><p>I call version 2 as â€œHigh-quality modeâ€, and provide an option for users who are routed to version 1 to switch to this mode.</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-try-high-quality-mode@2x.jpg\" alt=\"ExploreTrees.SG showing a link â€œTry high-quality mode?â€œ\" width=\"300\" height=\"440\" loading=\"lazy\"></figure><p>This option will reload the page and switch to version 2 by appending <code>#hq</code> to the URL. After that if the site crashes, the user can still go back to version 1.</p><p>To further optimise the performance of the site, I make good use of the <code>renderingMode</code> variable to conditionally enable or disable certain features on the map. I took one step ahead by applying <a href=\"https://parceljs.org/code_splitting.html\">code splitting</a> with dynamic imports. I extract all version 2 related dependencies into a separate bundle and load it asynchronously on the page.</p><pre><code>const {\n  MapboxLayer,\n  AmbientLight,\n  SunLight,\n  LightingEffect,\n  ScatterplotLayer,\n  SolidPolygonLayer,\n  SimpleMeshLayer,\n  SphereGeometry,\n  msgpack,\n  polyline,\n  KDBush,\n  geokdbush,\n  circle,\n  throttle,\n} = await import('./hq.bundle');\n</code></pre><p>Besides that, I did an interesting trick for the MessagePack data file. I realised that MessagePack doesnâ€™t have an <a href=\"https://github.com/msgpack/msgpack/issues/194\">official MIME type</a>. Even though I started using Parcel for bundling files, the site is still deployed to GitHub Pages via the <a href=\"https://github.com/JamesIves/github-pages-deploy-action\">GitHub Pages Deploy Action</a>. This means gzip compression could only be available for certain file extensions.</p><p>For example, <code>.js</code> files will be served with gzip compression but not <code>.png</code> files. I tried using <code>.mp</code> extension for the MessagePack file andâ€¦ itâ€™s not compressed unfortunately ğŸ˜Ÿ. Since the site traffic is also handled by Cloudflare, I looked through <a href=\"https://support.cloudflare.com/hc/en-us/articles/200168396\">the list of content types that Cloudflare will compress</a>.</p><p>I needed a file format thatâ€¦</p><ul><li>Is whitelisted in the server's content type compression list, from either GitHub Pages or Cloudflare. Iâ€™m aware that <a href=\"https://www.netlify.com/docs/headers-and-basic-auth/\">Netlify allows custom headers</a> which may be able to set gzip headers, but Iâ€™m not moving the site there for now.</li><li>Bypasses Parcelâ€™s <a href=\"https://parceljs.org/assets.html\">intelligent asset handling</a>. For example, if <code>.json</code> is used, Parcel will include the file content <em>into</em> the JavaScript bundle.</li><li>Is not confusing for me to revisit in the future. If I use <code>.png</code>, which could work, the future me would be confused and wonder why itâ€™s used for a non-image file ğŸ˜….</li></ul><p>I tried pre-compressing the file into <code>.gz</code> but weird things just happen when trying to read the file in JS. ğŸ˜…</p><p>In the end, I chose <code>.ico</code> because itâ€™s one of the formats that is a (image) binary <em>and</em> can be gzip compressed at the same time. It is also rarely used, unlike normal image formats, which could prevent conflicts with other files. I could use <code>.ttf</code> or <code>.otf</code> extensions too but it could be confused with actual font files.</p><p>I named the file as <code>trees.min.mp.ico</code>, tested it and it works. ğŸ¤©</p><h2>The launch and the aftermath</h2><p>On <a href=\"https://twitter.com/cheeaun/status/1123053445546512384\">30 April 2019</a>, I finally relaunched <a href=\"https://exploretrees.sg/\">ExploreTrees.SG V2</a>.</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-screenshot.gif\" alt=\"GIF screenshot of ExploreTrees.SG\" width=\"1136\" height=\"640\" loading=\"lazy\"></figure><p>Despite all my effort rewriting the code and pushing the limits, Iâ€™m especially proud of the 3D trees. It feels like an <strong>achievement-unlocked</strong> moment for me. ğŸ¤©</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/exploretrees-sg-3d-trees-overview@2x.jpg\" alt=\"ExploreTrees.SG showing an overview of all 3D trees\" width=\"1366\" height=\"1024\" loading=\"lazy\"></figure><p>It got <a href=\"https://www.reddit.com/r/singapore/comments/bj0xze/my_friend_took_nparkss_data_and_built_a_site_for/\">featured on Reddit /r/singapore</a>, thanks to a friend ğŸ˜‰.</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/reddit-friend-took-nparks-data-built-site-visualise-trees-singapore@2x.png\" alt=\"Reddit post on /r/singapore titled â€œMy friend took NParksâ€™s data and built a site for people to visualise the various trees around Singapore&quot;\" width=\"320\" height=\"472\" loading=\"lazy\"></figure><p>Feedback has been positive so far. Iâ€™m surprised that the conditional routing for Version 1 and 2 seems smooth enough that no one noticed it. ğŸ˜</p><p>A day after the launch, I <a href=\"https://twitter.com/cheeaun/status/1123589545230880769\">received a pretty interesting email</a> at 2 AM.</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/software/email-map-building-help@2x.jpg\" alt=\"Email titled â€œMap Building Helpâ€, received at 2:14 AM\" width=\"375\" height=\"667\" loading=\"lazy\"></figure><p>So this person asked me for my <em>advice</em> on creating a map for all <strong>durian trees in Singapore</strong>! I was reading this in the morning, had a good laugh and ignored it. ğŸ˜‚</p><p>It was Labor Day and thereâ€™s no work. In the afternoon, I had a hunch that this person might <strong>not</strong> be joking after all.</p><p>So, I did some research on durians, found a Wikipedia page on <a href=\"https://en.wikipedia.org/wiki/List_of_Durio_species\">List of <em>Durio</em> species</a>, looked through the dataset and found <strong>286 Durio species</strong>! ğŸ˜±</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/software/terminal-node-script-durian-durio-species@2x.png\" alt=\"Terminal showing a node script for durian listing down the durio species\" width=\"533\" height=\"281\" loading=\"lazy\"></figure><p>I didnâ€™t know that there are durian trees in Singapore! Even more surprising, <a href=\"https://en.wikipedia.org/wiki/Durian\">durian</a> trees have <a href=\"http://www.wildsingapore.com/wildfacts/plants/fruittrees/durio/zibethinus.htm\">flowers</a>! ğŸ˜±</p><p>The next logical step is to quickly load them up <a href=\"https://gist.github.com/cheeaun/1d68f6acb589a30335e1c7c927153d18\">on a map</a>.</p><figure><img src=\"https://cheeaun.com/blog/images/screenshots/web/durio-species-trees-map@2x.png\" alt=\"Durio species trees plotted on a map\" width=\"679\" height=\"402\" loading=\"lazy\"></figure><p>Looking at this, I was thinking to myself. Are there any other fruit trees in Singapore? I searched through the Internet and found a list of fruit tree species names. I was thinking of how to visualise the fruits on a map, maybe <em>still</em> colorful circles or fruit icons instead? There could be too many exotic fruits to be shown so maybe need to be filtered to only those â€œpopularâ€ ones?</p><p>Hmm, yeahâ€¦ Lots of ideas, yet so little time.</p><p>From my experience in <a href=\"https://cheeaun.com/blog/2016/01/building-side-projects/\">building side projects</a>, itâ€™s always good to hold on to an idea for some time before executing them. This time, Iâ€™ve already had <strong>so much fun</strong> rebuilding everything, squeezing every inch of the performance, and even modelling 3D trees on a map. Most importantly I manage to launch my <a href=\"https://github.com/cheeaun/exploretrees-sg\">open-source</a> work to the public before I got bored of it. ğŸ˜†</p><p>This has been fun and Iâ€™ve learnt a lot.</p><p>So, till next time then. ğŸ˜‰</p></div></div>","author":"Lim Chee Aun","siteTitle":"cheeaunblog","siteHash":"15c7c44e2960b5b47196ecb9d24e84a8cf386d0c7c30998ce31cc3eee11d971a","entryHash":"ab685c82e1c10c0a715aef6d3d5b9099ac3948cb778c990a4f8a06dcde7a3512","category":"Tech"}