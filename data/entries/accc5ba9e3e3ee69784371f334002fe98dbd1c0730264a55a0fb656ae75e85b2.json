{"title":"ทำความเข้าใจ “MQTT with TLS” ใน AWS IoT Core สักหน่อย","link":"https://thanapon.info/mqtt-with-tls-on-aws-iot-core/?utm_source=rss&utm_medium=rss&utm_campaign=mqtt-with-tls-on-aws-iot-core","date":1678029256000,"content":"<p>พอดีมีคำถามกับตัวเองว่า เอ๊ะ MQTT with TLS มันทำงานยังไงนะ แล้วทำไมตอนเชื่อมต่อ device เข้ากับ Message Broker จำเป็นต้องยัด Client certificate ลงไปด้วยนะ ก็เลยไปหาคำตอบมา ร่ายตั้งแต่ต้นเลยละกันนะ</p>\n\n\n\n<h2>เกริ่นก่อนนะ ปกติเราจะเข้ารหัสกันยังไง!!! </h2>\n\n\n\n<p>หลังจากไปทำการบ้านมาก็เข้าใจว่าปัจจุบันจะมีการเข้ารหัสอยู่ทั้งหมด 2 แบบด้วยกัน</p>\n\n\n\n<p>ซึ่งแบบแรกเป็นการเข้ารหัสแบบ <strong>Symmetric Encryption</strong> หมายถึงการเข้ารหัสแบบทางเดียว คือเราใช้แค่ Secret key ชุดเดียวกันในการเข้ารหัส [Encrypt] และถอดรหัส [Decrypt]</p>\n\n\n\n<p>ยกตัวอย่างเช่น “Token : akakleni192j5,ma” อะไรบลาๆ</p>\n\n\n<div>\n<figure><img width=\"640\" height=\"319\" src=\"https://thanapon.info/wp-content/uploads/2023/03/image.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/03/image.png 640w, https://thanapon.info/wp-content/uploads/2023/03/image-300x150.png 300w, https://thanapon.info/wp-content/uploads/2023/03/image-600x299.png 600w\" /><figcaption>Ref: https://en.wikipedia.org/wiki/Symmetric-key_algorithm</figcaption></figure></div>\n\n\n<p><strong>Asymmetric Encryption</strong> แปลตรงๆก็คือการเข้ารหัสแบบไม่สมมาตร ซึ่งหลักการทำงานคือ มีกุญแจอยู่ 2 ชุด ชุดแรกเอาไว้เข้ารหัส [Public Key] ส่วนกุญแจอีกดอกก็เอาไว้ถอดรหัส [Private Key] ซึ่งสุดท้ายแล้วเราจะเอา Public/Private Key นี้หล่ะไปคุยกันต่อในการทำ Digital Signature ซึ่งจะเอาไว้ใช้สำหรับการ Authenticate [Sign] และการ Verify ข้อมูลว่าเป็นข้อมูลของคนๆนี้จริงๆนะ ไม่ใช่ Attacker</p>\n\n\n<div>\n<figure><img width=\"800\" height=\"490\" src=\"https://thanapon.info/wp-content/uploads/2023/03/image-1.png\" srcset=\"https://thanapon.info/wp-content/uploads/2023/03/image-1.png 800w, https://thanapon.info/wp-content/uploads/2023/03/image-1-300x184.png 300w, https://thanapon.info/wp-content/uploads/2023/03/image-1-768x470.png 768w, https://thanapon.info/wp-content/uploads/2023/03/image-1-600x368.png 600w\" /><figcaption>Ref: https://www.okta.com/identity-101/asymmetric-encryption/</figcaption></figure></div>\n\n\n<h2>ที่มาของ SSL/TLS คือยังไงนะ</h2>\n\n\n\n<p>SSL/TLS ทั้งคู่ใช่ทั้ง <strong>Symmetric Encryption</strong> และ <strong>Asymmetric Encryption</strong> ในการส่งข้อมูลหากัน โดยที่จะใช้ <strong>Asymmetric Encryption</strong> ในการ Setup connection ระหว่าง Server &lt;-&gt; Client ส่วน <strong>Symmetric Encryption</strong> จะใช้ในการส่งข้อมูลหากันภายใน Secure Session</p>\n\n\n\n<p>SSL ย่อมาจาก Secure Sockets Layer ซึ่งเป็น Protocol ที่ใช้สำหรับเข้ารหัสและป้องกันข้อมูลในขณะที่มีการส่งข้อมูลกันหากันผ่าน Internet</p>\n\n\n\n<p>ส่วน TLS ก็คือ Transport Layer Security ซึ่งก็เป็น Protocol ตัวใหม่กว่าที่ถูกพัฒนามาจาก SSL ซึ่งเข้ามาแก้ไขเรื่อง Security ของ SSL อีกที </p>\n\n\n\n<p>โดยที่ AWS IoT Core นั้นจะ Support TLS 1.2 และจะใช้ Server authentication หรือ Client authentication ก็ได้ แต่ถ้าใครอยากใช้วิธีแปลกๆ ก็ไปใช้ <a href=\"https://docs.aws.amazon.com/iot/latest/developerguide/custom-authentication.html\" target=\"_blank\">Custom Authentication</a> เอาเด้อ</p>\n\n\n\n<h2>Server authentication กับ Client authentication ต่างกันยังไงนะ</h2>\n\n\n\n<p><strong>Server authentication</strong>; User จะใช้ Public Key ที่ได้รับมาจาก Server ในการเข้ารหัส [Encrypt] ก่อนที่จะส่งข้อมูลไปยัง Server ส่วน Server ก็แค่ถอดรหัส [Decrypt] โดยใช้ Private Key ก็จบ ซึ่งวิธีนี้เราจะเก็บ Public Key ไว้ที่ Client เพื่อใช้ในการ Authen กันนะ</p>\n\n\n\n<p>ในส่วนของ <strong>AWS IoT client authentication</strong> นั้น Client จะต้องเก็บ Private Key, Client Certificate ไว้กับตัวเพื่อใช้ในการ Authen ซึ่งจะต้องไป validate กับ AWS IoT Core อีกที่ โดยที่ Client Certificate นั้นจะเอาไว้สำหรับ verify ความถูกต้องระหว่าง Private Key กับ Public Key นั้นว่ามีความสอดคล้องกันหรือไม่ภายใน AWS IoT Core</p>\n\n\n\n<p>สรุปก็คือ ถ้าให้เลือกใช้งาน MQTT with TLS แนะนำให้ใช้ Client Authenticate เพราะว่าจะมีความปลอดภัยมากซึ่งสามารถสรุปได้ดังนี้</p>\n\n\n\n<ul>\n<li>เราสามารถ Verify และ Identity MQTT Client ที่เข้ามาต่อกับ Broker ได้</li>\n\n\n\n<li>การ Authenticate MQTT Client จะเกิดขึ้น​ ณ Transport Layer ซึ่งถ้าหาก TLS Handshake ยังไม่สำเร็จ  MQTT Client ก็ยังไม่สามารถ Connect และส่งข้อความมาที่ Broker ได้เลย</li>\n</ul>\n\n\n\n<p>ซึ่งก็มี Overhead เหมือนกัน ในด้าน CPU และ Memory เองเพราะถ้าเป็นอุปกรณ์ Embedded system ตัวเล็กๆ ก็อาจจะรองรับไม่ไหวก็ได้นะ</p>\n\n\n\n<blockquote>\n<p><a href=\"https://www.hivemq.com/blog/mqtt-security-fundamentals-tls-ssl/\" target=\"_blank\">TLS/SSL – MQTT Security Fundamentals</a></p>\n<cite><a href=\"https://www.hivemq.com/blog/mqtt-security-fundamentals-tls-ssl/\" target=\"_blank\">https://www.hivemq.com/blog/mqtt-security-fundamentals-tls-ssl/</a></cite></blockquote>\n\n\n\n<blockquote>\n<p><a href=\"https://www.hivemq.com/blog/mqtt-security-fundamentals-x509-client-certificate-authentication/\" target=\"_blank\">X509 Client Certificate Authentication – MQTT Security Fundamentals</a></p>\n<cite><a href=\"https://www.hivemq.com/blog/mqtt-security-fundamentals-x509-client-certificate-authentication/\" target=\"_blank\">https://www.hivemq.com/blog/mqtt-security-fundamentals-x509-client-certificate-authentication/</a></cite></blockquote>\n\n\n\n<blockquote>\n<p><a href=\"https://docs.aws.amazon.com/iot/latest/developerguide/security.html\" target=\"_blank\">Security in AWS IoT</a></p>\n<cite><a href=\"https://www.hivemq.com/blog/mqtt-security-fundamentals-x509-client-certificate-authentication/\" target=\"_blank\">https://www.hivemq.com/blog/mqtt-security-fundamentals-x509-client-certificate-authentication/</a></cite></blockquote><p>The post <a href=\"https://thanapon.info/mqtt-with-tls-on-aws-iot-core/\">ทำความเข้าใจ “MQTT with TLS” ใน AWS IoT Core สักหน่อย</a> first appeared on <a href=\"https://thanapon.info\">Thanapon</a>.</p>","author":"thanapon.tap","siteTitle":"Thanapon","siteHash":"6a039c2f54d76e4c49227d80968f2a30de5427cc57525c047c383ea3563cde5f","entryHash":"accc5ba9e3e3ee69784371f334002fe98dbd1c0730264a55a0fb656ae75e85b2","category":"Thai"}